// Generated by CoffeeScript 1.6.3
(function() {
  var $, AppView, Application, ApplicationList, ApplicationView, FilterView, Image, ImageList, ImageView,
    _this = this;

  $ = jQuery;

  Application = Backbone.Model.extend({
    start: function() {
      var req,
        _this = this;
      return req = $.post('/api/start/' + this.get('id')).done(function() {
        _this.set('status', 'started');
        _this.set('status_type', 'up');
        return $('#messages').notify({
          type: 'success',
          message: {
            text: 'The process has been started'
          }
        }).show();
      }).fail(function(data) {
        return $('#messages').notify({
          type: 'danger',
          message: {
            text: data.responseJSON['error']
          }
        }).show();
      });
    },
    restart: function() {
      var req,
        _this = this;
      return req = $.post('/api/restart/' + this.get('id')).done(function() {
        _this.set('status', 'started');
        return $('#messages').notify({
          type: 'success',
          message: {
            text: 'The process has been restarted'
          }
        }).show();
      }).fail(function(data) {
        return $('#messages').notify({
          type: 'danger',
          message: {
            text: data.responseJSON['error']
          }
        }).show();
      });
    },
    stop: function() {
      var req,
        _this = this;
      return req = $.post('/api/stop/' + this.get('id')).done(function() {
        _this.set('status', 'stopped');
        return $('#messages').notify({
          type: 'success',
          message: {
            text: 'The process has been stopped'
          }
        }).show();
      }).fail(function(data) {
        return $('#messages').notify({
          type: 'danger',
          message: {
            text: data.responseJSON['error']
          }
        }).show();
      });
    }
  });

  ApplicationList = Backbone.Collection.extend({
    model: Application,
    url: '/api/applications',
    started: function() {
      return this.filter(function(app) {
        return app.get('status_type') === 'up';
      });
    },
    stopped: function() {
      return this.filter(function(app) {
        return app.get('status_type') === 'exit';
      });
    }
  });

  Image = Backbone.Model.extend();

  ImageList = Backbone.Collection.extend({
    model: Image,
    url: '/api/images',
    comparator: function(image) {
      return -image.get('created_timestamp');
    }
  });

  window.Applications = new ApplicationList;

  window.Images = new ImageList;

  ApplicationView = Backbone.View.extend({
    tagName: 'tr',
    template: Handlebars.templates['application.hbs'],
    events: {
      'click .js-app-restart': 'restart',
      'click .js-app-stop': 'stop',
      'click .js-app-start': 'start'
    },
    initialize: function() {
      return this.listenTo(this.model, 'change', this.render);
    },
    render: function() {
      window.model = this.model;
      this.$el.html(this.template(this.model.toJSON()));
      return this;
    },
    stop: function() {
      return _this.model.stop();
    },
    start: function() {
      return this.model.start();
    },
    restart: function() {
      return this.model.restart();
    }
  });

  ImageView = Backbone.View.extend({
    tagName: 'tr',
    template: Handlebars.templates['image.hbs'],
    initialize: function() {
      return this.listenTo(this.model, 'change', this.render);
    },
    render: function() {
      window.model = this.model;
      this.$el.html(this.template(this.model.toJSON()));
      return this;
    }
  });

  FilterView = Backbone.View.extend({
    tagName: 'div',
    template: Handlebars.templates['filters.hbs'],
    events: {
      'click .js-filter-all': 'showAll',
      'click .js-filter-stopped': 'showStopped',
      'click .js-filter-started': 'showStarted'
    },
    render: function() {
      this.$el.html(this.template());
      return this;
    },
    showAll: function() {
      return App.addAllApplications();
    },
    showStopped: function() {
      return App.addStoppedApplications();
    },
    showStarted: function() {
      return App.addStartedApplications();
    }
  });

  AppView = Backbone.View.extend({
    el: $('.js-application'),
    initialize: function() {
      this.listenTo(Applications, 'add', this.addOneApplication);
      this.listenTo(Applications, 'reset', this.addAllApplications);
      this.listenTo(Images, 'add', this.addOneImage);
      this.listenTo(Images, 'reset sort', this.addAllImages);
      this.filters = new FilterView();
      $('.js-filters').append(this.filters.render().el);
      Applications.fetch();
      return Images.fetch();
    },
    addOneApplication: function(app) {
      var view;
      view = new ApplicationView({
        model: app
      });
      return $('#application-list tbody').append(view.render().el);
    },
    addAllApplications: function() {
      $('#application-list tbody').empty();
      return Applications.each(this.addOneApplication, this);
    },
    addStoppedApplications: function() {
      $('#application-list tbody').empty();
      return _.each(Applications.stopped(), this.addOneApplication);
    },
    addStartedApplications: function() {
      $('#application-list tbody').empty();
      return _.each(Applications.started(), this.addOneApplication);
    },
    addOneImage: function(image) {
      var view;
      view = new ImageView({
        model: image
      });
      return $('#image-list tbody').append(view.render().el);
    },
    addAllImages: function() {
      $('#image-list tbody').empty();
      return Images.each(this.addOneImage, this);
    }
  });

  $(document).ready(function() {
    return window.App = new AppView;
  });

}).call(this);
